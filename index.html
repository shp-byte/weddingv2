<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×¨×š ×œ×—×•×¤×” - ××™×›×œ ×•×™× ×•×Ÿ</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f1d592;
            --white: #ffffff;
            --text: #4a4a4a;
            --success: #4CAF50;
            --error: #e57373;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text);
            margin: 0;
            padding: 0;
            direction: rtl;
            background-color: #fdfaf5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ×¨×§×¢ ×“×§×•×¨×˜×™×‘×™ */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1511795409834-ef04bbd61622?q=80&w=2069&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            opacity: 0.1;
            z-index: -1;
        }

        .container {
            width: 95%;
            max-width: 650px;
            margin: 20px auto;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        h1 { background: linear-gradient(135deg, #d4af37, #f1d592); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.2rem; margin-top: 10px; }

        .screen { display: none; animation: fadeIn 0.5s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        button {
            padding: 12px 25px;
            font-size: 18px;
            border-radius: 50px;
            border: none;
            background: linear-gradient(135deg, #d4af37, #b8962d);
            color: white;
            cursor: pointer;
            transition: 0.3s;
            margin: 8px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
            width: calc(100% - 16px);
        }
        button:hover { transform: scale(1.02); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        .chuppah-visual {
            width: 100%;
            max-width: 500px;
            height: 200px;
            margin: 0 auto 20px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 2px solid var(--gold-light);
        }
        .chuppah-visual img { width: 100%; height: 100%; object-fit: cover; }

        .chuppah-path {
            height: 350px;
            background: radial-gradient(circle, #fdf8f5 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            margin: 30px 0;
            border-bottom: 3px solid var(--gold-light);
        }

        .participant-icon {
            position: absolute;
            bottom: 20px;
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        .avatar-circle {
            width: 55px;
            height: 55px;
            background: white;
            border: 3px solid var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .participant-info { font-size: 11px; background: white; padding: 3px 6px; border-radius: 8px; margin-top: 5px; white-space: nowrap; font-weight: bold; }

        .selection-card { padding: 12px; border: 2px solid #eee; border-radius: 15px; cursor: pointer; transition: 0.2s; background: white; font-size: 14px; margin-bottom: 8px; text-align: right; }
        .selection-card.selected { border-color: var(--gold); background: #fffdf5; }

        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; padding: 15px; background: white; border-radius: 15px; }
        .avatar-option { font-size: 24px; cursor: pointer; border: 2px solid #eee; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }
        .avatar-option.selected { border-color: var(--gold); background: #fffdf5; transform: scale(1.1); }

        input { padding: 15px; width: 100%; border-radius: 15px; border: 1px solid #ddd; margin-bottom: 15px; text-align: center; box-sizing: border-box; font-size: 16px; }

        #msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 30px; border-radius: 50px; color: white; display: none; z-index: 2000; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        .option-btn { background: white; color: var(--text); border: 1px solid #eee; text-align: right; padding-right: 20px; }
        .option-btn.selected { background: var(--gold-light); }

        .couple-btn { background: white; color: #FF69B4; border: 2px solid #FF69B4; margin: 10px 0; }
        .couple-btn:hover { background: #fff0f6; }
    </style>
</head>
<body>

<div id="msg"></div>

<!-- ××¡×š ×¤×ª×™×—×” -->
<div id="role-selection" class="container screen active">
    <div class="chuppah-visual">
        <img src="https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=1000&auto=format&fit=crop" alt="×—×•×¤×” ××¢×•×¦×‘×ª">
    </div>
    <h1>×‘×“×¨×š ×œ×—×•×¤×” ğŸ’</h1>
    <h3>××™×›×œ ×•×™× ×•×Ÿ ××ª×—×ª× ×™×</h3>
    <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 15px;">
        <button onclick="initApp('player')">×× ×™ ××©×ª×ª×£/×ª (××•×¨×—)</button>
        <button onclick="initApp('couple')" style="background: linear-gradient(135deg, #FF69B4, #FF1493); margin-top: 10px;">×× ×—× ×• ×”×–×•×’ (××™×›×œ ×•×™× ×•×Ÿ)</button>
        <button onclick="initApp('host')" style="background: #555; margin-top: 10px;">××¡×š ×¨××©×™ (×”×§×¨× ×”)</button>
    </div>
</div>

<!-- ×¨×™×©×•× ××•×¨×— - ×©×œ×‘ 1 -->
<div id="player-setup-1" class="container screen">
    <h2>× ×¢×™× ×œ×”×›×™×¨!</h2>
    <input id="playerName" type="text" placeholder="××™×š ×§×•×¨××™× ×œ×›×?">
    <p style="margin-top: 20px; font-weight: bold;">×‘×—×¨×• ×ª×•××¨ ××©×¤×—×ª×™ ××¦×—×™×§:</p>
    <div id="descList"></div>
    <button onclick="goToAvatarSelection()" style="margin-top: 15px;">×”××©×š â¬…ï¸</button>
</div>

<!-- ×¨×™×©×•× ××•×¨×— - ×©×œ×‘ 2 -->
<div id="player-setup-2" class="container screen">
    <h2>×‘×—×¨×• ×××•×’'×™ ×©×™×™×¦×’ ××ª×›×</h2>
    <div id="avatarList" class="avatar-grid"></div>
    <button onclick="joinGame()" style="margin-top: 20px;">×‘×•××• × ×©×—×§! ğŸ‰</button>
</div>

<!-- ×”××ª× ×” -->
<div id="waiting-room" class="container screen">
    <h2 id="wait-title">××ª×›×•× × ×™× ×œ×—×•×¤×”...</h2>
    <div id="my-identity-preview" style="margin: 25px 0; font-weight: bold; font-size: 20px; color: var(--gold);"></div>
    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ’</div>
    <p>×”××ª×™× ×• ×©×”×× ×—×” ×™×¤×¢×™×œ ××ª ×”×¡×™×˜×•××¦×™×” ×”×‘××”</p>
</div>

<!-- ××©×—×§ ××•×¨×— -->
<div id="player-game" class="container screen">
    <h3 id="q-text" style="font-size: 22px; margin-bottom: 20px; color: var(--gold);"></h3>
    <div id="q-options"></div>
    <div id="p-status-box" style="margin-top: 20px; padding: 15px; border-radius: 15px; display: none;">
        <p id="p-status" style="font-weight: bold; margin: 0;"></p>
    </div>
</div>

<!-- ××©×—×§ ×”×–×•×’ -->
<div id="couple-game" class="container screen">
    <h2 style="color: #FF1493;">××” ×‘×××ª ×§×•×¨×” ×‘×™× ×™×›×? â¤ï¸</h2>
    <p id="couple-q-text" style="font-size: 20px; font-weight: bold; margin: 25px 0;"></p>
    <div id="couple-options"></div>
    <p id="couple-waiting" style="color: #888; font-style: italic; display: none; margin-top: 30px;">×”×‘×—×™×¨×” × ×§×œ×˜×”! ×”××ª×™× ×• ×œ×× ×—×”.</p>
</div>

<!-- ××¡×š ×¨××©×™ (×”×§×¨× ×”) -->
<div id="main-board-view" class="container screen" style="max-width: 900px;">
    <h1>×”××¡×¢ ×©×œ ××™×›×œ ×•×™× ×•×Ÿ ğŸ’’</h1>
    <p id="host-q-desc" style="font-size: 26px; font-weight: bold; color: var(--gold); min-height: 90px; padding: 0 20px;"></p>
    
    <div id="host-reveal-status" style="display:none; margin: 15px 0; color: var(--success); font-weight: bold; font-size: 24px;">
        ××™×›×œ ×•×™× ×•×Ÿ ×‘×—×¨×• ×ª×©×•×‘×”! âœ¨
    </div>

    <div class="chuppah-path" id="path-container">
        <div style="position: absolute; left: 10px; top: -45px; font-size: 70px; z-index: 5;">ğŸ’’</div>
    </div>

    <div id="host-controls" style="margin-top: 30px;">
        <button id="startBtn" onclick="updateGameStep(0)" style="max-width: 300px;">×”×ª×—×œ ××©×—×§ ğŸ‰</button>
        <button id="nextBtn" style="display:none; max-width: 300px;" onclick="stepForward()">×¡×™×˜×•××¦×™×” ×”×‘××” â¬…ï¸</button>
        <button onclick="resetGame()" style="background: transparent; color: #999; font-size: 11px; box-shadow: none; text-decoration: underline; width: auto;">××™×¤×•×¡</button>
    </div>
    
    <div style="margin-top: 20px; color: #888;">
        ××©×ª×ª×¤×™× ××—×•×‘×¨×™×: <span id="player-count" style="font-weight: bold; color: var(--gold);">0</span>
    </div>
</div>

<script>
/* ====== FIREBASE CONFIG ====== */
const firebaseConfig = {
  apiKey: "AIzaSyD2uL7Ql7_cmh3kMWQh_nLcJ2sg9gLUjbQ",
  authDomain: "weddinggame-179d5.firebaseapp.com",
  projectId: "weddinggame-179d5",
  storageBucket: "weddinggame-179d5.firebasestorage.app",
  messagingSenderId: "812758178545",
  appId: "1:812758178545:web:f882b3ef22893e7ab5e750",
  measurementId: "G-CBYZS3L2J2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const appId = "michal-yinon-wedding-final";
const gameConfigDocPath = `artifacts/${appId}/public/data/config/gameStatus`;
const participantsColPath = `artifacts/${appId}/public/data/participants`;

/* ====== GAME CONTENT ====== */
const questions = [
    { q: "×œ×™×œ×”, ××•×’×•×¡×˜. ×™× ×•×Ÿ ×¨×•×¦×” 16 ××¢×œ×•×ª ×‘××–×’×Ÿ, ××™×›×œ ×¨×•×¦×” ×©××™×›×ª ×¤×•×š ×•×’×¨×‘×™×™×. ××” ×”×¤×©×¨×”?", options: ["×™× ×•×Ÿ × ×›× ×¢ ×•×™×©×Ÿ ×‘×—×•×", "××™×›×œ ×™×©× ×” ×¢× ××¢×™×œ ×“×•×‘×•×Ÿ ×•×—×œ×•×§", "××›×‘×™× ×•××“×œ×™×§×™× ×›×œ ×©×¢×” ×›×©×™× ×•×Ÿ × ×¨×“×", "×¤×•×ª×—×™× ×—×œ×•×Ÿ ×•××ª×¤×œ×œ×™× ×œ×¨×•×— ×™×¨×•×©×œ××™×ª"] },
    { q: "12 ×‘×œ×™×œ×”, ×¢×•×“ ×™×•×©×‘×™× ×¢×œ ×”×¡×¤×” ×•×”×‘×¨×– ×¤×ª××•× ××ª×—×™×œ ×œ×˜×¤×˜×£. ××” ×™×¢×©×•?", options: ["×™× ×•×Ÿ ×§× ×‘××§×¦×•×¢×™×•×ª ×œ××¨×’×– ×”×›×œ×™×", "××™×›×œ ××•××¨×ª ×©×–×” ××•×–×™×§×ª ×¨×§×¢ ××¨×’×™×¢×”", "×“×™×•×Ÿ ×× ×œ×”×–××™×Ÿ ××™× ×¡×˜×œ×˜×•×¨ ×‘×—×™×¨×•×", "×¡××¨×˜×•×˜ ××ª×—×ª ×œ×˜×¤×˜×•×£ ×•××‘×˜×™×—×™× ×œ×ª×§×Ÿ '××—×¨'"] },
    { q: "×™×¦××ª× ×œ×˜×™×•×œ '×§×œ×™×œ'. ×™× ×•×Ÿ ×××¨ ×¨×‘×¢ ×©×¢×”, ×‘×¤×•×¢×œ ××ª× 3 ×©×¢×•×ª ×‘×§×•×¦×™× ×•××™×Ÿ ××™×.", options: ["××™×›×œ ××ª×—×™×œ×” ×œ×©×™×¨ ×©×™×¨×™ ×˜×™×•×œ×™×", "×™× ×•×Ÿ: '×”× ×”, ×¨×•××™× ×›×‘×¨ ××ª ×”××•×˜×•'", "×¡×¢×•×“×” ×××•×œ×ª×¨×ª ××‘××‘×” ×©××¦××• ×‘×ª×™×§", "××™×›×œ ××—×›×” ×œ××¡×•×§ ×—×™×œ×•×¥ ×¢×œ ××‘×Ÿ"] },
    { q: "××•×¦××™ ×©×‘×ª, ×¢×™×™×¤×•×ª ×©×™×. ×©× ×™×”× ×¨×•×¦×™× ×›×•×¡ ×§×¤×”, ××‘×œ ×œ××£ ××—×“ ××™×Ÿ ×›×— ×œ×§×•×.", options: ["××‘×Ÿ × ×™×™×¨ ×•××¡×¤×¨×™×™× - ×”××¤×¡×™×“ ××›×™×Ÿ", "×™× ×•×Ÿ ××©×—×“ ××ª ××™×›×œ ×‘×©×˜×™×¤×ª ×›×œ×™×", "× ×¨×“××™× ×œ×¤× ×™ ×©××—×œ×™×˜×™× ××™ ×§×", "×™× ×•×Ÿ ×§× ×•××•××¨ '××œ ×ª×§×•××™ ××ª ×¢×™×™×¤×”'"] },
    { q: "×™× ×•×Ÿ ×××¨×™×š ×‘×“×‘×¨ ×ª×•×¨×” ×‘×§×™×“×•×© ××¦×œ ×”×”×•×¨×™×. ×”×•× ×›×‘×¨ 10 ×“×§×•×ª ××“×‘×¨, ×›×•×œ× ×¨×¢×‘×™×.", options: ["××™×›×œ ××©×ª×¢×œ×ª '×“×™×¤×œ×•××˜×™×ª' ×•××—×œ×§×ª ×¡×œ×˜×™×", "××™×›×œ × ×”× ×™×ª ×•××‘×§×©×ª ××× ×• ×¢×•×“", "×™× ×•×Ÿ ×§×•×œ×˜ ××ª ×”××‘×˜×™× ×•×—×•×ª×š ×‘×©×™×", "××™×Ÿ ××¦×‘ ×©×™× ×•×Ÿ ××“×‘×¨ ×™×•×ª×¨ ×-2 ×“×§×•×ª"] },
    { q: "×”×’×¢×” ××”×¡×•×¤×¨ ×¢× 15 ×©×§×™×•×ª. ×™× ×•×Ÿ ×× ×¡×” ×œ×§×—×ª ×”×›×œ ×‘××›×” ××—×ª.", options: ["×™× ×•×Ÿ × ×ª×§×¢ ×‘×“×œ×ª ×•×©×§×™×ª ×—×œ×‘ ××ª×¤×•×¦×¦×ª", "××™×›×œ ×œ×•×§×—×ª ×©×§×™×ª ××—×ª ×§×˜× ×” ×‘× ×—×ª", "×™× ×•×Ÿ ××’×™×¢ ×œ××˜×‘×— ××‘×œ ×œ× ×™×›×•×œ ×œ×¤×ª×•×— ××¦×‘×¢×•×ª", "××©××™×¨×™× ×—×¦×™ ×‘××•×˜×• ×•'× ×‘×™× ××ª ×–×” ××—×¨'"] },
    { q: "×™×© ×‘×¨×™×ª ×‘-10:00 ×‘×‘×•×§×¨ ×‘×¦×“ ×”×©× ×™ ×©×œ ×”××¨×¥. ×”×©×¢×” 9:15. ××™×š ×–×” × ×¨××”?", options: ["××™×›×œ ××•×›× ×”, ×™× ×•×Ÿ ××—×¤×© ×—×•×œ×¦×”", "×™× ×•×Ÿ ×‘××•×˜×• ×¢× ×”×× ×•×¢ ×“×•×œ×§, ××™×›×œ ×‘×•×“×§×ª ×”×›×œ", "×××¦×™××™× ×ª×™×¨×•×¥ ×¢×œ ×¤×§×§ ×“××™×•× ×™", "××—×œ×™×˜×™× ×©'×”×¢×™×§×¨ ×”×›×•×•× ×”' ×•××’×™×¢×™× ×œ×§×™× ×•×—×™×"] },
    { q: "×™×•× ×¨××©×•×Ÿ ×‘×‘×•×§×¨, ×”×›×™×•×¨ ×¢×•×œ×” ×¢×œ ×’×“×•×ª×™×•. ××™ × ×•×’×¢ ×‘×–×”?", options: ["×¢×•×©×™× ×”×¡×›× ×—×œ×•×§×” ×”×•×’×Ÿ", "×™× ×•×Ÿ: '××•×œ×™ ×–×” ×™×¢×œ× ××¢×¦××•'", "××™×›×œ ××ª×§×ª×§×ª ×”×›×œ ×ª×•×š ×›×“×™ ×”×¡×‘×¨×™× ×œ×™× ×•×Ÿ", "××—×œ×™×˜×™× ×œ×”×©×ª××© ×¨×§ ×‘×—×“-×¤×¢××™ ××”×™×•×"] }
];

const funnyDescs = ["×”×™×œ×“×™× ×©×¨×•×“×¤×™× ××—×¨×™ ×¡×•×›×¨×™×•×ª", "×”××— ×©×©×›×— ×œ×”×›×™×Ÿ ×“×‘×¨ ×ª×•×¨×”", "×‘×Ÿ ×“×•×“ ×©×‘× ×œ×¢×–×•×¨", "×”××—×•×ª ×©××›×™× ×” ××¦×’×•×ª", "×¡×‘× ×©×“×•××’ ×œ×”×›×™×¨ ××ª ×›×•×œ×", "×¡×‘×ª× ×©×¨×•×§×“×ª ×‘×œ×™ ×”×¤×¡×§×”"];
const avatars = ["ğŸ¤µâ€â™‚ï¸", "ğŸ‘°â€â™€ï¸", "ğŸ§”â€â™‚ï¸", "ğŸ‘µ", "ğŸ‘´", "ğŸ‘¶", "ğŸ’ƒ", "ğŸ•º", "ğŸ’‘", "ğŸ’", "ğŸ’’", "ğŸ’", "ğŸ’", "â¤ï¸", "ğŸ•", "ğŸ“œ", "ğŸ•¯ï¸", "ğŸ•Šï¸", "ğŸ·", "ğŸ‡", "ğŸ¥³", "ğŸ°", "ğŸ¥¨", "ğŸ", "ğŸ§¿", "ğŸ¶", "ğŸ‘Ÿ"];

let myState = { role: '', name: '', description: '', avatar: '', uid: '', score: 0 };

/* ====== CORE LOGIC ====== */
async function initApp(role) {
    myState.role = role;
    try {
        await auth.signInAnonymously();
        myState.uid = auth.currentUser.uid;
        if (role === 'host') setupHostView();
        else if (role === 'couple') setupCoupleView();
        else setupPlayerSetup();
    } catch (e) {
        console.error("Auth failed", e);
        toast("×©×’×™××ª ×—×™×‘×•×¨", "var(--error)");
    }
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function toast(text, color = 'var(--gold)') {
    const m = document.getElementById('msg');
    m.innerText = text; m.style.backgroundColor = color; m.style.display = 'block';
    setTimeout(() => m.style.display = 'none', 3000);
}

/* ====== HOST LOGIC ====== */
function setupHostView() {
    showScreen('main-board-view');
    db.doc(gameConfigDocPath).onSnapshot(doc => {
        const data = doc.data() || { step: -1, correctAns: null };
        const hDesc = document.getElementById('host-q-desc');
        const startBtn = document.getElementById('startBtn');
        const nextBtn = document.getElementById('nextBtn');
        const revealStatus = document.getElementById('host-reveal-status');

        if (data.step === -1) {
            hDesc.innerText = "××¦×˜×¨×¤×™× ×œ××©×—×§... ×—×¤×©×• ××ª ×”×§×™×©×•×¨!";
            startBtn.style.display = "inline-block";
            nextBtn.style.display = "none";
        } else if (data.step < questions.length) {
            startBtn.style.display = "none";
            nextBtn.style.display = "inline-block";
            hDesc.innerText = `×¡×™×˜×•××¦×™×” ${data.step + 1}: ${questions[data.step].q}`;
            revealStatus.style.display = (data.correctAns !== null) ? "block" : "none";
        } else {
            hDesc.innerText = "×”×’×¢× ×• ×œ×—×•×¤×”! ××–×œ ×˜×•×‘ ×œ××™×›×œ ×•×™× ×•×Ÿ! ğŸ’";
            nextBtn.style.display = "none";
        }
    });

    db.collection(participantsColPath).onSnapshot(snap => {
        const parts = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderPath(parts);
        document.getElementById('player-count').innerText = parts.length;
    });
}

function renderPath(parts) {
    const container = document.getElementById('path-container');
    container.querySelectorAll('.participant-icon').forEach(el => el.remove());
    const total = questions.length;
    parts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'participant-icon';
        const progress = (p.score / total) * 85; 
        div.style.right = `${progress}%`;
        div.style.marginBottom = `${p.score * 12}px`;
        let status = '';
        if (p.lastCorrect === true) status = 'border-color: var(--success); box-shadow: 0 0 15px var(--success);';
        if (p.lastCorrect === false) status = 'opacity: 0.6;';
        div.innerHTML = `<div class="avatar-circle" style="${status}">${p.avatar || 'ğŸ‘¤'}</div><div class="participant-info">${p.name}</div>`;
        container.appendChild(div);
    });
}

async function updateGameStep(s) {
    await db.doc(gameConfigDocPath).set({ step: s, correctAns: null }, { merge: true });
}

function stepForward() {
    db.doc(gameConfigDocPath).get().then(doc => {
        const next = (doc.data()?.step ?? -1) + 1;
        updateGameStep(next);
    });
}

async function resetGame() {
    await updateGameStep(-1);
    const snap = await db.collection(participantsColPath).get();
    const batch = db.batch();
    snap.docs.forEach(d => batch.delete(d.ref));
    await batch.commit();
}

/* ====== COUPLE LOGIC ====== */
function setupCoupleView() {
    showScreen('couple-game');
    db.doc(gameConfigDocPath).onSnapshot(doc => {
        const data = doc.data() || { step: -1, correctAns: null };
        const qText = document.getElementById('couple-q-text');
        const optionsDiv = document.getElementById('couple-options');
        const waitingMsg = document.getElementById('couple-waiting');

        if (data.step === -1 || data.step >= questions.length) {
            qText.innerText = "×”××ª×™× ×• ×©×”×× ×—×” ×™×ª×—×™×œ ××ª ×”×¡×™×˜×•××¦×™×”...";
            optionsDiv.innerHTML = "";
            waitingMsg.style.display = "none";
        } else {
            if (data.correctAns !== null) {
                qText.innerText = "×”×‘×—×™×¨×” ×©×œ×›× × ×§×œ×˜×”!";
                optionsDiv.innerHTML = "";
                waitingMsg.style.display = "block";
            } else {
                qText.innerText = questions[data.step].q;
                waitingMsg.style.display = "none";
                renderCoupleOptions(questions[data.step].options, data.step);
            }
        }
    });
}

function renderCoupleOptions(opts, step) {
    const container = document.getElementById('couple-options');
    container.innerHTML = "";
    opts.forEach((o, i) => {
        const btn = document.createElement('button');
        btn.className = "couple-btn";
        btn.innerText = o;
        btn.onclick = () => submitCorrectAnswer(i, step);
        container.appendChild(btn);
    });
}

async function submitCorrectAnswer(idx, step) {
    const snap = await db.collection(participantsColPath).get();
    const batch = db.batch();
    snap.docs.forEach(d => {
        const p = d.data();
        if (p.lastStep === step) {
            const isCorrect = (p.choice === idx);
            batch.update(d.ref, { lastCorrect: isCorrect, score: isCorrect ? (p.score + 1) : p.score });
        }
    });
    await batch.commit();
    await db.doc(gameConfigDocPath).update({ correctAns: idx });
}

/* ====== PLAYER LOGIC ====== */
function setupPlayerSetup() {
    const dList = document.getElementById('descList');
    dList.innerHTML = "";
    funnyDescs.forEach(d => {
        const c = document.createElement('div');
        c.className = "selection-card"; c.innerText = d;
        c.onclick = () => {
            myState.description = d;
            document.querySelectorAll('.selection-card').forEach(x => x.classList.remove('selected'));
            c.classList.add('selected');
        };
        dList.appendChild(c);
    });
    const aList = document.getElementById('avatarList');
    aList.innerHTML = "";
    avatars.forEach(av => {
        const o = document.createElement('div');
        o.className = "avatar-option"; o.innerText = av;
        o.onclick = () => {
            myState.avatar = av;
            document.querySelectorAll('.avatar-option').forEach(x => x.classList.remove('selected'));
            o.classList.add('selected');
        };
        aList.appendChild(o);
    });
    showScreen('player-setup-1');
}

function goToAvatarSelection() {
    myState.name = document.getElementById('playerName').value.trim();
    if (!myState.name || !myState.description) return toast("××œ××• ××ª ×›×œ ×”×¤×¨×˜×™×", "var(--error)");
    showScreen('player-setup-2');
}

async function joinGame() {
    if (!myState.avatar) return toast("×‘×—×¨×• ×“××•×ª", "var(--error)");
    await db.doc(`${participantsColPath}/${myState.uid}`).set({
        name: myState.name, description: myState.description, avatar: myState.avatar, score: 0, lastCorrect: null, lastStep: -1, choice: null
    });
    document.getElementById('my-identity-preview').innerText = `${myState.avatar} ${myState.name}`;
    showScreen('waiting-room');
    listenToGame();
}

function listenToGame() {
    db.doc(gameConfigDocPath).onSnapshot(doc => {
        const data = doc.data();
        if (!data || data.step === -1) showScreen('waiting-room');
        else if (data.step < questions.length) renderPlayerQuestion(data.step, data.correctAns);
        else showScreen('waiting-room');
    });
}

function renderPlayerQuestion(step, correct) {
    const q = questions[step];
    const qT = document.getElementById('q-text');
    const qO = document.getElementById('q-options');
    const pS = document.getElementById('p-status-box');
    const pST = document.getElementById('p-status');

    db.doc(`${participantsColPath}/${myState.uid}`).get().then(pDoc => {
        const pData = pDoc.data();
        if (!pData) return;
        qT.innerText = q.q;
        qO.innerHTML = "";
        showScreen('player-game');

        if (pData.lastStep === step && pData.choice !== null) {
            pS.style.display = "block";
            if (correct !== null) {
                pS.style.background = pData.lastCorrect ? "#e8f5e9" : "#fbe9e7";
                pST.innerText = pData.lastCorrect ? "×¦×“×§×ª×! ××™×›×œ ×•×™× ×•×Ÿ ×‘×××ª ×‘×—×¨×• ×‘×–×” âœ¨" : `××•×¤×¡, ×”×–×•×’ ×‘×—×¨ ××—×¨×ª...`;
                pST.style.color = pData.lastCorrect ? "var(--success)" : "var(--error)";
            } else {
                pS.style.background = "#fff8e1";
                pST.innerText = "×”×”×™××•×¨ × ×©×œ×—! ××—×›×™× ×œ×–×•×’...";
            }
        } else pS.style.display = "none";

        q.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = `option-btn ${pData.choice === i ? 'selected' : ''}`;
            btn.innerText = opt;
            btn.disabled = (pData.lastStep === step && pData.choice !== null);
            btn.onclick = async () => {
                await db.doc(`${participantsColPath}/${myState.uid}`).update({ choice: i, lastStep: step });
                renderPlayerQuestion(step, correct);
            };
            qO.appendChild(btn);
        });
    });
}
</script>
</body>
</html>
